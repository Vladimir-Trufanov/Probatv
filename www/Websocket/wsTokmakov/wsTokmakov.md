## [wsTokmakov - изучение материалов по сайтам Токмакова](wsTokmakov/wsTokmakov.md)

Примеры клиента и сокет-сервера на PHP по материалам сайтов:

### [WebSocket сервер на PHP](https://tokmakov.msk.ru/blog/item/202)

### [GitHub: web-socket-server](https://github.com/tokmakov/web-socket-server)

### Общие рекомендации по запуску PHP-скриптов в командной строке Windows:

- Откройте командную строку. Для этого зажмите сочетание клавиш Win+R, введите «***cmd***» и нажмите ***Enter***. 

- Убедитесь, что PHP установлен в системе. Чтобы проверить наличие PHP и узнать установленную версию, введите ***php -v***. Если PHP не установлен, загрузите и установите его с официального сайта PHP. 

- Создайте PHP-скрипт, используя любой текстовый редактор. 

- Запустите скрипт. В командной строке пропишите команду ***php script.php***. 

- Также рекомендуется добавить путь до PHP в переменную окружения PATH в Windows. Это позволит не указывать каждый раз полный путь до файла php.exe. 

### Как начать пользоваться TelNet в Windows 11:

Чтобы пользоваться Telnet в Windows 11, необходимо включить эту функцию через настройки операционной системы:

- Откройте «Панель управления». Для этого нажмите клавиши Win + R на клавиатуре (либо правой кнопкой мыши по кнопке «Пуск» и выберите пункт «Выполнить»).

- Введите ***appwiz.cpl*** и нажмите ***Enter***. В открывшемся окне в панели слева нажмите по пункту «***Включение или отключение компонентов Windows***». 

- Отметьте «***Клиент Telnet***» в списке доступных компонентов и нажмите «***Ок***».  Дождитесь, когда клиент Telnet будет установлен. 

- Для начала использования достаточно будет запустить командную строку, ввести команду ***telnet*** и нажать ***Enter***. 

Важно учитывать риски безопасности при использовании Telnet, так как он отправляет данные в открытом виде. Это может привести к подслушиванию конфиденциальной информации, например, имён пользователей и паролей.

### tokEx1 - первый пример, как есть, из материалов Токмакова

- по ***simple.php*** создаём файл сервера ***tokEx1SocketServer.php***;

- запускаем его в работу в каталоге из командной строки:

***php.exe -f tokEx1SocketServer.php***

```
Microsoft Windows [Version 10.0.26200.7623]
(c) Корпорация Майкрософт (Microsoft Corporation). Все права защищены.

c:\Probatv\www\Websocket\wsTokmakov\tokEx1>php.exe -f tokEx1SocketServer.php
SERVER START
Socket create...
Socket bind...
Set options...
Listening socket...
Waiting for connections...

```

- по ***Win+R*** загружаем другую командную строку, запускаем ***telnet*** и видим его подключение:

```
Добро пожаловать в программу-клиент Microsoft Telnet

Символ переключения режима: 'CTRL+]'

Microsoft Telnet>

```

- Получив приглашение telnet, даем команду: ***open 127.0.0.1 7777***. Убеждаемся, что получили ответ от сервера и завершили его работу:

```
Hello, Client!

Подключение к узлу утеряно.

Нажмите любую клавишу...

```

### tokEx2 - пример с эхо-сервером из материалов Токмакова

- создаем класс WebSocketServer в файле ***tokEx2WebSocketServer.php***;

- для тестирования напишем PHP-скрипт, который запускает в работу сервер и все сообщения клиента отправляет обратно ***tokEx2echo-server.php***;

- для тестирования работы сервера создаем клиента ***tokEx2SocketClient.html***,
js-скрипт ***tokEx2socket.js*** и файл стилей ***tokEx2style.css***;

- tokEx2SocketClient.html в index.html и запускаем, как сайт;

- ***php.exe -f tokEx2echo-server.php***;

### tokEx3 - пример index.html для echo.websocket.org

В данном каталоге загружен подправленный клиент со страницы ***https://echo.websocket.org/.ws*** и снятый со [страницы](https://echo.websocket.org/) тестовый сервер ***echo-websocket-org***.


### tokEx4 - пример index.html для echo.websocket.org из материалов Токмакова

Вначале делаем сайт для клиента на ***localhost:88*** из ***index.html, tokEx4socket.js.js, tokEx4style.css***. Пытаемся соединиться с ***ws://echo.websocket.org***. Не получилось, ошибка 1006.

Но, когда заменил на ***wss://echo.websocket.org*** получился вот такой диалог:

```
Соединение с сервером установлено
Получено сообщение от сервера: Request served by 1781505b56ee58
Отправлено сообщение серверу: Привет!
Получено сообщение от сервера: Привет!
```

### tokEx5 - пример с com-сервером из материалов Токмакова

На будущее - список ошибок при работе с сокетами:

```
***Defined Status Codes***

- 1000 CLOSE_NORMAL. 1000 указывает на нормальное завершение работы, то есть на то, что цель, ради которой было установлено соединение, достигнута.

- 1001 CLOSE_GOING_AWAY. 1001 означает, что конечная точка «закрывается», например, сервер выходит из строя или браузер переходит на другую страницу.

- 1002 CLOSE_PROTOCOL_ERROR. 1002 указывает на то, что конечная точка завершает соединение из-за ошибки протокола.

- 1003 CLOSE_UNSUPPORTED. 1003 указывает на то, что конечная точка завершает соединение, поскольку получила тип данных, который она не может принять (например, конечная точка, которая понимает только текстовые данные, МОЖЕТ отправить этот код, если получит двоичное сообщение).

- 1004 Зарезервировано. Конкретное значение может быть определено в будущем.

- 1005 CLOSED_NO_STATUS. 1005 — это зарезервированное значение, которое НЕ ДОЛЖНО использоваться в качестве кода состояния в кадре управления закрытием конечной точкой. Оно предназначено для использования в приложениях, ожидающих код состояния, указывающий на отсутствие кода состояния.

- 1006 CLOSE_ABNORMAL. 1006 — это зарезервированное значение, которое НЕ ДОЛЖНО использоваться в качестве кода состояния в управляющем кадре закрытия конечной точкой. Оно предназначено для использования в приложениях, ожидающих код состояния, указывающий на то, что соединение было закрыто ненормально, например, без отправки или получения управляющего кадра закрытия:

  a) клиент сокета в браузере работал не по протоколу сервера сокета;
  б) истекло максимально заданное время работы сервера сокета.

- 1007 Unsupported payload. 1007 означает, что конечная точка завершает соединение, так как получила данные в сообщении, которые не соответствуют типу сообщения (например, данные, отличные от UTF-8 [RFC3629], в текстовом сообщении).

- 1008 Policy violation. 1008 указывает на то, что конечная точка завершает соединение, поскольку получила сообщение, нарушающее её политику. Это общий код состояния, который может быть возвращён, если нет другого более подходящего кода состояния (например, 1003 или 1009) или если необходимо скрыть конкретные сведения о политике.

- 1009 CLOSE_TOO_LARGE. 1009 означает, что конечная точка завершает соединение, так как получила слишком большое для обработки сообщение.

- 1010 Mandatory extension - Обязательное продление. 1010 указывает на то, что конечная точка (клиент) завершает соединение, так как ожидала, что сервер согласует одно или несколько расширений, но сервер не вернул их в ответном сообщении при установлении соединения WebSocket. Списокнеобходимых расширений ДОЛЖЕН отображаться в части /reason/ кадра закрытия. Обратите внимание, что этот код состояния не используется сервером, так как он может привести к сбою при установлении соединения WebSocket.

- 1011 Server error. 1011 означает, что сервер завершает соединение, так как столкнулся с непредвиденной ситуацией, которая помешала ему выполнить запрос.

- 1012 Service restart - Перезапуск службы. 1012 указывает, что сервер / служба перезапускается.

- 1013 Try again later - Попробуйте еще раз позже. 1013 указывает на то, что временное состояние сервера вынудило его заблокировать запрос клиента.

1014 Bad gateway - Плохие врата. 1014 означает, что сервер, выступающий в качестве шлюза, получил неверный ответ.

1015 TLS handshake fail - Сбой рукопожатия TLS. 1015 является зарезервированным значением и НЕ ДОЛЖЕН использоваться в качестве кода состояния в кадре управления закрытием конечной точкой. Он предназначен для использования в приложениях, ожидающих код состояния, указывающий на то, что соединение было закрыто из-за невозможности выполнить рукопожатие TLS (например, сертификат сервера не может быть проверен).

***Reserved Status Code Ranges***

- 0-999. Коды состояния в диапазоне 0-999 не используются.

- 1000-2999. Коды состояния в диапазоне 1000–2999 зарезервированы для определения в рамках этого протокола, его будущих версий и расширений, указанных в постоянной и общедоступной спецификации.

- 3000-3999. Коды состояния в диапазоне 3000-3999 зарезервированы для использования библиотеками, фреймворками и приложениями. Эти коды состояния зарегистрированы непосредственно в IANA. Интерпретация этих кодов не определена данным протоколом.

- 4000-4999. Коды состояния в диапазоне 4000-4999 зарезервированы для частного использования и, следовательно, не могут быть зарегистрированы. Такие коды могут использоваться по предварительным соглашениям между приложениями WebSocket. Толкование этих кодов настоящим протоколом не определено.
```




